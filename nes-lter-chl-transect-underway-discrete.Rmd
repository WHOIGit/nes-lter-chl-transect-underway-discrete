---
title: "R Notebook"
output: html_notebook
---


```{r}
library(dplyr)
library(readr)
library(here)
library(glue)
library(readxl)
library(xml2)
library(rlog)

library(EML)
library(EMLassemblyline)
library(ediutilities)
```

```{r}
data_dir <- here('nes-lter-chla-post-calibration')

post_cal_fluo <- merge_csv_directory(glue('{data_dir}/post-cal-fluo'))
post_cal_fluo$fluorescence_manufacturer_cal <- NULL

uw_discrete_cont_match <- merge_csv_directory(glue('{data_dir}/uw_discrete_cont_match'))
uw_discrete_cont_match$fluo_1_wetstar_match <- NULL
uw_discrete_cont_match$fluo_2_ecofl_match <- NULL
uw_discrete_cont_match$iode_quality_flag <- as.factor(uw_discrete_cont_match$iode_quality_flag)

output_dir <- here('data_tables')
dir.create(output_dir)

write_csv(post_cal_fluo, glue('{output_dir}/chl-transect-underway-post-cal.csv'), na='NaN')
write_csv(uw_discrete_cont_match, glue('{output_dir}/chl-transect-underway-discrete.csv'), na='NaN')
```

```{r}
# define input files
edi_filename <- "chl-transect-underway"
metadata <- glue('{edi_filename}-info')
pkg_id <- "knb-lter-nes.999.1" # dummy package ID for development

# Make EML Templates 
excel_to_template(metadata_path = metadata, 
                  edi_filename = edi_filename, 
                  rights = "CCBY",
                  other_info = TRUE)

sheet_to_tsv('chl-transect-underway-info.xlsx', 'CategoricalVariables',
             glue::glue('catvars_chl-transect-underway-post-cal.txt'))

sheet_to_tsv('chl-transect-underway-info.xlsx', 'CategoricalVariables',
             glue::glue('catvars_chl-transect-underway-discrete.txt'))

sheet_to_tsv('chl-transect-underway-post-cal.xlsx', 'ColumnHeaders',
             glue::glue('attributes_chl-transect-underway-post-cal.txt'))

sheet_to_tsv('chl-transect-underway-discrete.xlsx', 'ColumnHeaders',
             glue::glue('attributes_chl-transect-underway-discrete.txt'))

EMLassemblyline::template_core_metadata(path=here(), license='CCBY')
```
```{r}

temp_coverage <- temporal_coverage(append(post_cal_fluo$date_time_utc,
                                          uw_discrete_cont_match$date_time_utc))

dataset_title = 'Underway discrete chlorophyll and post-calibrated underway fluorometer data during NES-LTER Transect cruises, ongoing since 2019'

make_eml(path=here(),
         data.path=output_dir,
         dataset.title=dataset_title,
         data.table=c('chl-transect-underway-post-cal.csv',
                      'chl-transect-underway-discrete.csv'),
         data.table.description=c('This is a placeholder description',
                                  'This is a placeholder description 2'),
         data.table.name = c('This is a placeholder table name',
                             'This is a placeholder table name 2'),
         temporal.coverage = temp_coverage,
         geographic.description = "NES-LTER Transect",
         geographic.coordinates =
           geographic_coordinates(append(post_cal_fluo$latitude,
                                         uw_discrete_cont_match$latitude),
                                  append(post_cal_fluo$longitude,
                                         uw_discrete_cont_match$longitude)),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

project_insert(pkg_id)
```

